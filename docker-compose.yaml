version: '3.8'

networks:
  default:
    name: drones_default

services:
  # === Drone Simulation Infrastructure ===
  sitl:
    image: aether-drone-node
    container_name: sitl-drone
    ports:
      - "5760:5760" # MAVLink direct (Cloud Bridge)
      - "5762:5762" # MAVLink secondary (MAVProxy/QS)
    environment:
      - INSTANCE=0
      - SERIAL0=tcp:5760
      - SERIAL1=tcp:5762
    
  # === Local MQTT Broker ===
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf

  # === Cloud Bridge (Edge) ===
  cloud-bridge:
    image: aether-cloud-bridge
    container_name: cloud-bridge
    depends_on:
      - sitl
      - mosquitto
    environment:
      - MAVLINK_CONNECTION=tcp:sitl-drone:5762
      # Dev Mode Configuration
      - LOCAL_BROKER_HOST=mosquitto
      - LOCAL_BROKER_PORT=1883
      # - IOT_ENDPOINT=${IOT_ENDPOINT} (Uncomment and set env var for AWS)


